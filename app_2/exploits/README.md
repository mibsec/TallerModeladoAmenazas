# Exploits - PayFast Vulnerable Application

## Descripción

Este directorio contiene Proof of Concepts (PoCs) que demuestran el impacto real de las vulnerabilidades encontradas en la aplicación PayFast.

> **ADVERTENCIA**: Estos scripts son SOLO para pruebas de seguridad autorizadas en entornos controlados. El uso no autorizado es ilegal.

---

## Resumen de Vulnerabilidades

| # | Vulnerabilidad | Archivo | Línea | CVSS | CWE |
|---|----------------|---------|-------|------|-----|
| 1 | SSRF | worker.py | 10-13 | 9.1 | CWE-918 |
| 2 | Flask Debug RCE | core.py | 12 | 10.0 | CWE-489, CWE-94 |
| 3 | Traefik Sin Auth | docker-compose.yml | 7 | 7.5 | CWE-306 |
| 4 | PostgreSQL Sin Auth | docker-compose.yml | 40 | 9.8 | CWE-306, CWE-287 |
| 5 | Docker Socket Exposed | docker-compose.yml | 13 | 10.0 | CWE-250 |
| 6 | Network Misconfiguration | docker-compose.yml | 47 | 7.5 | CWE-923 |

---

## Scripts de Explotación

### 01_ssrf_internal_scan.py
**Vulnerabilidad**: Server-Side Request Forgery (SSRF)
**Ubicación**: `worker.py:10-13`

```bash
python3 01_ssrf_internal_scan.py
```

**Impacto demostrado**:
- Escaneo de red interna
- Acceso a servicios no expuestos
- Potencial robo de credenciales cloud (AWS/GCP Metadata)

---

### 02_flask_debug_rce.py
**Vulnerabilidad**: Flask Debug Mode en Producción
**Ubicación**: `core.py:12`

```bash
python3 02_flask_debug_rce.py
```

**Impacto demostrado**:
- Detección de debug mode
- Cálculo de PIN de Werkzeug
- Ejecución remota de código (RCE)

---

### 03_traefik_dashboard_exploit.py
**Vulnerabilidad**: API de Traefik sin autenticación
**Ubicación**: `docker-compose.yml:7`

```bash
python3 03_traefik_dashboard_exploit.py
```

**Impacto demostrado**:
- Exposición de topología de red
- Descubrimiento de servicios backend
- Reconocimiento para ataques posteriores

---

### 04_postgres_no_auth.py
**Vulnerabilidad**: PostgreSQL sin autenticación
**Ubicación**: `docker-compose.yml:40`

```bash
python3 04_postgres_no_auth.py
```

**Impacto demostrado**:
- Acceso total a base de datos
- Robo de datos sensibles
- Escalación de privilegios

---

### 05_docker_socket_escape.py
**Vulnerabilidad**: Docker socket montado en contenedor
**Ubicación**: `docker-compose.yml:13`

```bash
python3 05_docker_socket_escape.py
```

**Impacto demostrado**:
- Escape de contenedor
- Acceso root al host
- Compromiso de infraestructura completa

---

### 06_network_segmentation_bypass.py
**Vulnerabilidad**: Red service-mesh sin aislamiento
**Ubicación**: `docker-compose.yml:47`

```bash
python3 06_network_segmentation_bypass.py
```

**Impacto demostrado**:
- Bypass de segmentación de red
- Exfiltración de datos
- Reverse shells a Internet

---

### 07_full_attack_chain.py
**Cadena de ataque completa**

```bash
python3 07_full_attack_chain.py
```

**Demuestra**:
- Compromiso total desde Internet
- Encadenamiento de todas las vulnerabilidades
- Escalación de privilegios hasta root en host

---

## Cadena de Ataque

```
┌─────────────────────────────────────────────────────────────────┐
│                    CADENA DE ATAQUE COMPLETA                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Internet (Atacante)                                            │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────┐                                                    │
│  │  SSRF   │  POST /webhook {"url": "http://internal/..."}      │
│  └────┬────┘                                                    │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────┐                                            │
│  │ Reconocimiento  │  Traefik API → Topología de red            │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │ Acceso a BD     │  PostgreSQL (trust) → Datos sensibles      │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │ RCE (Debug)     │  Flask Debugger → Ejecución de código      │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │ Container Escape│  Docker Socket → Acceso al host            │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │   ROOT HOST     │  Compromiso total de infraestructura       │
│  └─────────────────┘                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Requisitos

```bash
pip install requests
```

Para el PoC de PostgreSQL (opcional):
```bash
# macOS
brew install postgresql

# Ubuntu/Debian
apt-get install postgresql-client
```

---

## Uso

1. Iniciar la aplicación vulnerable:
```bash
cd /path/to/app_2
docker-compose up -d
```

2. Ejecutar los PoCs:
```bash
cd exploits
python3 01_ssrf_internal_scan.py
python3 02_flask_debug_rce.py
# ... etc
```

3. Ejecutar cadena completa:
```bash
python3 07_full_attack_chain.py
```

---

## Remediaciones

### SSRF (worker.py)
```python
# Validar URLs antes de hacer requests
from urllib.parse import urlparse

ALLOWED_HOSTS = ['api.trusted.com', 'webhook.trusted.com']

def is_valid_url(url):
    parsed = urlparse(url)
    return parsed.hostname in ALLOWED_HOSTS and parsed.scheme == 'https'
```

### Flask Debug (core.py)
```python
# NUNCA usar debug=True en producción
app.run(host='0.0.0.0', port=5000, debug=False)

# Usar variable de entorno
import os
app.run(debug=os.environ.get('FLASK_DEBUG', 'False').lower() == 'true')
```

### Traefik (docker-compose.yml)
```yaml
# Remover --api.insecure=true
# Agregar autenticación
command:
  - "--api.dashboard=true"
labels:
  - "traefik.http.routers.api.middlewares=auth"
  - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$..."
```

### PostgreSQL (docker-compose.yml)
```yaml
environment:
  POSTGRES_PASSWORD: "contraseña_fuerte_aleatoria"
  # Remover POSTGRES_HOST_AUTH_METHOD: trust
```

### Docker Socket
```yaml
# Remover completamente
# volumes:
#   - /var/run/docker.sock:/var/run/docker.sock

# Si es necesario, usar docker-socket-proxy
```

### Network Segmentation
```yaml
networks:
  service-mesh:
    internal: true  # Cambiar a true
```

---

## Disclaimer

Estos scripts son proporcionados únicamente con fines educativos y para pruebas de seguridad autorizadas. El uso de estas herramientas contra sistemas sin autorización explícita es ilegal y no ético.

**Autor**: Taller de Modelado de Amenazas
**Fecha**: 2024
